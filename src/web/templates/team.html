{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12 text-center mb-4">
            <h1>{{ team_name }}</h1>
        </div>
    </div>

    <!-- Draft Player Form -->
    <div class="row justify-content-center mb-4">
        <div class="col-md-6">
            <form action="{{ url_for('draft_player', team_id=team_name) }}" method="post" class="d-flex" id="draft-form">
                <div class="flex-grow-1 me-2" style="position: relative;">
                    <input type="text" name="player_name" id="player-draft-input" class="form-control" placeholder="Enter player name to draft" required autocomplete="off">
                    <div id="autocomplete-results" class="list-group" style="position: absolute; width: 100%; z-index: 1000;"></div>
                </div>
                <button type="submit" class="btn btn-primary">Draft</button>
            </form>
        </div>
    </div>

    <!-- Draft Status Alert -->
    {% if draft_status %}
    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <div class="alert {% if draft_status == 'success' %}alert-success{% else %}alert-danger{% endif %} alert-dismissible fade show" role="alert">
                {% if draft_status == 'success' %}
                    Successfully drafted <strong>{{ drafted_player }}</strong>!
                {% else %}
                    <strong>Error:</strong> {{ drafted_player }}
                {% endif %}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Roster and Breakdown -->
    <div class="row mb-5">
        <!-- Current Roster Table -->
        <div class="col-md-8">
            <h2>Current Roster</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col">ADP</th>
                            <th scope="col">Name</th>
                            <th scope="col">Position</th>
                            <th scope="col">Team</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for player in roster %}
                        <tr>
                            <td>{{ player.adp }}</td>
                            <td>{{ player.player }}</td>
                            <td>{{ player.position }}</td>
                            <td>{{ player.team }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center">This team's roster is empty.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Position Breakdown Table -->
        <div class="col-md-4">
            <h2>Position Breakdown</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col">Position</th>
                            <th scope="col">Current</th>
                            <th scope="col">Max</th>
                            <th scope="col">Need</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in position_breakdown %}
                        <tr>
                            <td>{{ item.position }}</td>
                            <td>{{ item.current }}</td>
                            <td>{{ item.max }}</td>
                            <td>{{ item.need }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center">No position data available.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <form method="get" action="{{ url_for('read_team', team_id=team_name) }}" class="row g-3" id="filter-form">
                <div class="col-md-5">
                    <label for="exclude-teams" class="form-label">Exclude Teams</label>
                    <input type="text" class="form-control" id="exclude-teams" name="exclude_teams" placeholder="e.g., MCI,LIV,ARS" value="{{ exclude_teams }}">
                </div>
                <div class="col-md-5">
                    <label class="form-label">Exclude Positions</label>
                    <div>
                        {% for pos in all_positions %}
                        <div class="form-check form-check-inline">
                            <input class="form-check-input position-checkbox" type="checkbox" id="pos-{{ pos }}" value="{{ pos }}" {% if pos in exclude_positions %}checked{% endif %}>
                            <label class="form-check-label" for="pos-{{ pos }}">{{ pos }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    <input type="hidden" id="exclude-positions-input" name="exclude_positions" value="{{ exclude_positions }}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Filter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Suggestions Table -->
    <div class="row">
        <div class="col-12">
            <h2>Suggestions</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col">Score</th>
                            <th scope="col">Name</th>
                            <th scope="col">Position</th>
                            <th scope="col">Team</th>
                            <th scope="col">Fantasy Points</th>
                            <th scope="col">FP/Game</th>
                            <th scope="col">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for player in suggestions.players %}
                        <tr>
                            <td><strong>{{ player.recommendation_score | round(0) }}</strong></td>
                            <td>{{ player.player }}</td>
                            <td>
                                <span class="badge badge-position-{{ player.position[0].lower() }}">{{ player.position }}</span>
                            </td>
                            <td>{{ player.team }}</td>
                            <td>{{ "%.1f"|format(player.fpts) if player.fpts else '—' }}</td>
                            <td>{{ "%.2f"|format(player.fpg) if player.fpg else '—' }}</td>
                            <td>
                                {% if player.at_afcon %}
                                    <span class="badge bg-danger">AFCON</span>
                                {% elif player.injury_severity == 'Healthy' %}
                                    <span class="badge bg-success">Healthy</span>
                                {% elif 'Short Term' in player.injury_severity %}
                                    <span class="badge bg-info text-dark">Short Term</span>
                                {% elif 'Medium Term' in player.injury_severity %}
                                    <span class="badge bg-warning text-dark">Medium Term</span>
                                {% elif 'Long Term' in player.injury_severity %}
                                    <span class="badge bg-danger text-dark">Long Term</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center">No suggestions available for this team's needs.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {{ render_pagination(suggestions, 'page_suggestions', '') }}
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12 text-center">
            <a href="{{ url_for('read_root') }}" class="btn btn-primary">Back to Main Draft</a>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // AUTOCOMPLETE FOR PLAYER INPUT
    const playerInput = document.getElementById('player-draft-input');
    const resultsContainer = document.getElementById('autocomplete-results');

    playerInput.addEventListener('input', async (e) => {
        const query = e.target.value;
        resultsContainer.innerHTML = '';

        if (query.length < 2) {
            return;
        }

        try {
            const response = await fetch(`/api/players/autocomplete?q=${encodeURIComponent(query)}`);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();

            data.players.forEach(playerName => {
                const item = document.createElement('a');
                item.href = '#';
                item.textContent = playerName;
                item.classList.add('list-group-item', 'list-group-item-action');
                item.addEventListener('click', (event) => {
                    event.preventDefault();
                    playerInput.value = playerName;
                    resultsContainer.innerHTML = '';
                });
                resultsContainer.appendChild(item);
            });
        } catch (error) {
            console.error('There was a problem with the fetch operation:', error);
        }
    });

    // Hide results when clicking outside
    document.addEventListener('click', (e) => {
        if (!playerInput.contains(e.target)) {
            resultsContainer.innerHTML = '';
        }
    });

    // FILTER FORM - POSITION CHECKBOXES
    const filterForm = document.getElementById('filter-form');
    const excludePositionsInput = document.getElementById('exclude-positions-input');
    const positionCheckboxes = document.querySelectorAll('.position-checkbox');

    if (filterForm) {
        filterForm.addEventListener('submit', (e) => {
            // Gather checked positions
            const selectedPositions = Array.from(positionCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value)
                .join(',');

            // Set the hidden input value
            excludePositionsInput.value = selectedPositions;
        });
    }
});
</script>

{% endblock %}
