{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1>{{ player_name }}</h1>

            <!-- Status Badges -->
            <div class="mb-3">
                {% if at_afcon %}
                    <span class="badge bg-danger">⚠️ AFCON</span>
                {% elif injury_severity == 'Healthy' %}
                    <span class="badge bg-success">✓ Healthy</span>
                {% elif 'Short Term' in injury_severity %}
                    <span class="badge bg-warning text-dark">Short Term Injury</span>
                {% elif 'Medium Term' in injury_severity %}
                    <span class="badge bg-orange">Medium Term Injury</span>
                {% elif 'Long Term' in injury_severity %}
                    <span class="badge bg-danger">Long Term Injury</span>
                {% endif %}
            </div>

            <!-- Key Stats -->
            <div class="row mb-4">
                <div class="col-md-2">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Team</h6>
                            <p class="card-text fs-5"><strong>{{ player_data.get('team_title', 'N/A') }}</strong></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Position</h6>
                            <p class="card-text fs-5"><strong>{{ player_data.get('position', 'N/A') }}</strong></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">xG</h6>
                            <p class="card-text fs-5"><strong>{{ "%.2f"|format(player_data.get('xG', 0) | float) }}</strong></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">xA</h6>
                            <p class="card-text fs-5"><strong>{{ "%.2f"|format(player_data.get('xA', 0) | float) }}</strong></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Goals</h6>
                            <p class="card-text fs-5"><strong>{{ player_data.get('goals', 0) }}</strong></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card text-center">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Assists</h6>
                            <p class="card-text fs-5"><strong>{{ player_data.get('assists', 0) }}</strong></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Percentile Rankings</h5>
                        </div>
                        <div class="card-body" style="max-height: 300px;">
                            <canvas id="percentileChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12 text-center">
                    <a href="{{ url_for('read_root') }}" class="btn btn-primary">Back to Draft Board</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('percentileChart').getContext('2d');
    const chartData = {{ chart_data | tojson }};

    function getBarColor(value) {
        const r = Math.round(255 * (100 - value) / 100);
        const g = Math.round(255 * value / 100);
        return `rgba(${r}, ${g}, 0, 0.6)`;
    }

    const backgroundColors = chartData.percentiles.map(p => getBarColor(p));
    const borderColors = chartData.percentiles.map(p => getBarColor(p).replace('0.6', '1'));

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.labels,
            datasets: [{
                label: 'Percentile',
                data: chartData.percentiles,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1,
                barThickness: 15
            }]
        },
        options: {
            indexAxis: 'y',
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    min: 0,
                    max: 100,
                    ticks: {
                        stepSize: 25
                    }
                },
                y: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 12
                        }
                    }
                }
            },
            animation: {
                onComplete: (context) => {
                    const chart = context.chart;
                    const ctx = chart.ctx;
                    ctx.textAlign = 'center';
                    ctx.fillStyle = "rgba(0, 0, 0, 1)";
                    ctx.textBaseline = 'bottom';
                    ctx.font = "12px Arial";

                    const datasets = chart.config.data.datasets;
                    datasets.forEach((dataset, i) => {
                        const meta = chart.getDatasetMeta(i);
                        meta.data.forEach((bar, index) => {
                            const data = dataset.data[index];
                            ctx.fillText(Math.round(data), bar.x - 20, bar.y + 6);
                        });
                    });
                }
            }
        }
    });
});
</script>
{% endblock %}
